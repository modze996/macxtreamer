name: Release macOS DMG

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v0.2.0)'
        required: true

jobs:
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install cargo-bundle
        run: cargo install cargo-bundle --locked

      - name: Build release binary (universal)
        run: |
          cargo build --release --target aarch64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/aarch64-apple-darwin/release/macxtreamer \
            target/x86_64-apple-darwin/release/macxtreamer \
            -output target/universal-apple-darwin/release/macxtreamer

      - name: Bundle macOS .app
        run: |
          # Use cargo-bundle to create .app for the universal binary
          # We'll do it manually since cargo-bundle only targets native arch
          APP_NAME="macxtreamer"
          APP_DIR="target/macxtreamer.app"
          MACOS_DIR="${APP_DIR}/Contents/MacOS"
          RES_DIR="${APP_DIR}/Contents/Resources"

          mkdir -p "${MACOS_DIR}" "${RES_DIR}"

          cp target/universal-apple-darwin/release/${APP_NAME} "${MACOS_DIR}/${APP_NAME}"
          chmod +x "${MACOS_DIR}/${APP_NAME}"

          # Copy Info.plist
          cp assets/Info.plist "${APP_DIR}/Contents/Info.plist"

          # Copy icon if icns exists
          if [ -f "assets/macxtreamer.icns" ]; then
            cp assets/macxtreamer.icns "${RES_DIR}/macxtreamer.icns"
          fi

      - name: Create DMG
        run: |
          APP_DIR="target/macxtreamer.app"
          VERSION="${GITHUB_REF_NAME:-${{ github.event.inputs.tag }}}"
          DMG_NAME="macxtreamer_${VERSION}.dmg"

          # Create staging directory
          STAGING="target/dmg-staging"
          mkdir -p "${STAGING}"
          cp -R "${APP_DIR}" "${STAGING}/"

          # Create symlink to /Applications
          ln -s /Applications "${STAGING}/Applications"

          # Create DMG
          hdiutil create \
            -volname "macxtreamer ${VERSION}" \
            -srcfolder "${STAGING}" \
            -ov \
            -format UDZO \
            -o "target/${DMG_NAME}"

          echo "DMG_NAME=${DMG_NAME}" >> "$GITHUB_ENV"
          echo "DMG_PATH=target/${DMG_NAME}" >> "$GITHUB_ENV"

      - name: Get tag name
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release and upload DMG
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "macxtreamer ${{ steps.tag.outputs.tag }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: ${{ env.DMG_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
